// backup of section-parallax.js
// created 2025-09-11

(function () {
  'use strict';
  if (typeof window === 'undefined') return;

  var rm = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)');
  if (rm && rm.matches) return;

  var items = [];
  var ticking = false;

  function collect() {
    items = [];
    var nodeList = document.querySelectorAll('.ptl-pageNavHero[data-parallax="bg"]');
    if (!nodeList || !nodeList.length) return;

    for (var i = 0; i < nodeList.length; i++) {
      var sec = nodeList[i];
      var speed = parseFloat(sec.getAttribute('data-parallax-speed') || '0.6');
      if (!isFinite(speed)) speed = 0.6;
      speed = Math.max(0, Math.min(1, speed));

      var clampRatio = parseFloat(sec.getAttribute('data-parallax-clamp') || '0.12');
      if (!isFinite(clampRatio)) clampRatio = 0.12;
      clampRatio = Math.max(0, Math.min(0.3, clampRatio));

      var maxDistancePx = parseFloat(sec.getAttribute('data-parallax-distance') || '');
      if (!isFinite(maxDistancePx)) maxDistancePx = null;

      var minScale = parseFloat(sec.getAttribute('data-parallax-scale') || '');
      if (!isFinite(minScale) || minScale <= 1) minScale = null;

      var attrTarget = sec.getAttribute('data-parallax-target');
      var target = null;
      if (attrTarget) {
        try { target = sec.querySelector(attrTarget); } catch (e) { /* noop */ }
      }
      var tVideo = target || sec.querySelector('.ptl-pageNavHero__video');
      var tImg = (!tVideo && sec.querySelector('.ptl-pageNavHero__image img')) || null;
      var tPic = (!tVideo && !tImg && sec.querySelector('.ptl-pageNavHero__image')) || null;
      var tBg  = (!tVideo && !tImg && !tPic && sec.querySelector('.ptl-pageNavHero__bg')) || null;
      target = tVideo || tImg || tPic || tBg;
      if (!target) continue;

      sec.setAttribute('data-parallax-active', '1');

      items.push({ sec: sec, target: target, speed: speed, clampRatio: clampRatio, maxDistancePx: maxDistancePx, minScale: minScale, isVideo: !!tVideo });

      if (tVideo) {
        var onVideoReady = function () { applyParallax(); };
        tVideo.addEventListener('loadedmetadata', onVideoReady, { once: true });
        tVideo.addEventListener('loadeddata', onVideoReady, { once: true });
        tVideo.addEventListener('canplay', onVideoReady, { once: true });
      } else if (tImg && tImg.complete !== true) {
        tImg.addEventListener('load', function () { collect(); applyParallax(); }, { once: true });
      }
    }
  }

  function applyParallax() {
    if (!items.length) return;

    var scrollY = window.pageYOffset || document.documentElement.scrollTop || 0;
    for (var i = 0; i < items.length; i++) {
      var it = items[i];
      var rect = it.sec.getBoundingClientRect();
      var secTop = scrollY + rect.top;
      var dy = scrollY - secTop;

      var move = -dy * (1 - it.speed);
      var max = (it.maxDistancePx && it.maxDistancePx > 0) ? it.maxDistancePx : (rect.height * it.clampRatio);
      if (move > max) move = max;
      if (move < -max) move = -max;

      var needed = (2 * Math.abs(max)) / Math.max(1, rect.height);
      var scale = 1 + Math.min(1.5, needed) + 0.04;
      if (it.minScale && scale < it.minScale) scale = it.minScale;
      it.target.style.transform = 'translate3d(0,' + move.toFixed(2) + 'px,0) scale(' + scale.toFixed(3) + ')';
      it.target.style.willChange = 'transform';
    }
  }

  function onScroll() {
    if (ticking) return;
    ticking = true;
    requestAnimationFrame(function () {
      applyParallax();
      ticking = false;
    });
  }

  function init() {
    collect();
    applyParallax();
  }

  window.addEventListener('scroll', onScroll, { passive: true });
  window.addEventListener('resize', function () { collect(); onScroll(); });
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function () { init(); onScroll(); });
  } else {
    init(); onScroll();
  }
  window.addEventListener('load', function () { collect(); applyParallax(); }, { once: true });
})();
